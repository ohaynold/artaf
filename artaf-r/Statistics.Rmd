---
title: "Autoregressive Behavior of Aviation Weather Forecasts: Statistics"
author: "Oliver M. Haynold & Neal Ylitalo"
date: "`r Sys.Date()`"
#output: html_document
output:
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(usmap)
library(palettes)


knitr::opts_chunk$set(echo = FALSE)
```

```{r}
lines <- read_csv("../data/histograms/full_set/hist YearlyStations.csv.zip",
                  col_types = cols(
                    aerodrome = "f",
                    year="i",
                    variable="f",
                    previous="n",
                    current="n",
                    final="n",
                    count="i"
                  ))

stations <- read_csv("../config/stations.csv", 
                     col_types = cols(
                       station = "f",
                       name = "c",
                       latitude = "n",
                       longitude = "n",
                       center = "f"
                     )) %>%
              rename(aerodrome=station) %>%
              select(-center)
```


For now, this is just same sample analysis as a framework.

# Some Summary Statistics

We have loaded `r nrow(lines)` data lines for `r length(unique(lines$aerodrome))` aerodromes for configuration full_set.

## Distribution of Wind Speeds

```{r}
  wind_speed_hist <- lines %>% 
      filter(variable=="wind_speed" & current < 50) %>%
      group_by(current) %>%
      summarize(count=sum(count)) %>%
      ungroup()

 print(
   ggplot(wind_speed_hist, aes(x=current)) + 
     geom_histogram(aes(weight=count), binwidth = 1) +
     labs(title="Histogram of Wind Speeds", x="Wind Speed kts", y="Count") +
     theme_bw()
   )
```


```{r}
wind_speed_avg <- lines %>% 
      filter(variable=="wind_speed") %>%
      group_by(aerodrome) %>%
      summarize(current=mean(current)) %>%
      ungroup() %>%
      left_join(stations, by=c("aerodrome")) %>%
      filter(substr(aerodrome, 1, 1)=="K" | substr(aerodrome, 1, 2)=="PA" | substr(aerodrome, 1, 2)=="PH") 


plot_usmap(fill="grey") +
  geom_sf(data=usmap_transform(wind_speed_avg, input_names = c("longitude", "latitude")),
             aes(colour=current)) +
  scale_colour_gradientn(colours = heat.colors(10)) +
  labs(title = "Average wind forecast speed by location", colour="Knots")
```

# Autocorrelations

Now to the interesting part, the autocorrelations.

## Wind speed

We'll start with looking at changes in wind speed from the previous to the current
TAF as predictors of wind speed in the final TAF reported for a given hour. The data are
filtered to cases where the wind speed in the previous TAF, the current TAF as well as the
final TAF did not exceed 30 knots so as to filter out cases of extreme weather and transmission
errors, which may be hard to distinguish.

```{r, warning=FALSE}
plotdat <- lines %>%
  filter(variable=="wind_speed") %>%
  filter(previous <= 30, current <= 30, final <= 30) %>%
  mutate(change_from_previous=current-previous, change_to_final=final-current) %>%
  group_by(change_from_previous, change_to_final) %>%
  summarise(count=sum(count), .groups="drop")

print(
  ggplot(plotdat, aes(x=as.factor(change_from_previous), y=change_to_final, weight=count)) +
    geom_boxplot() +
    theme_bw() +
    labs(
      title="Changes in predicted wind speed vs. realization",
      x="Change in predicted wind speed",
         y="Change from prediction to final value") +
    geom_abline(slope=-1, intercept=31, linetype=4) +
    scale_x_discrete(breaks=c(-30,-25,-20,-15,-10,-5,0,5,10,15,20,25,30))
)

```

We notice a distinctive asymmetry in this plot. Whereas for reductions in predicted
wind speed, we hardly see much predictive value, increases in predicted wind speed
seem to be overly aggressive in the sense of the predictions not usually coming true.

It seems that for increases in predicted wind speed of 25 knots or more, we can back these out
entirely, so these may reflect transmission errors.  For smaller increases, however, we can
back out about a third of the increase for the median, with about equal changes that we can
beack out the entire change or that the change will come substantially true.

Repeating the analysis by year, we see that the pattern appears largely unchanged.

```{r,warning=FALSE}

plotdat <- lines %>%
  filter(variable=="wind_speed") %>%
  filter(previous <= 30, current <= 30, final <= 30) %>%
  mutate(change_from_previous=current-previous, change_to_final=final-current) %>%
  group_by(year, change_from_previous, change_to_final) %>%
  summarise(count=sum(count), .groups = "drop") %>%
  mutate(increase=pmax(change_from_previous,0), decrease=pmin(change_from_previous, 0)) %>%
  ungroup()

print(
  ggplot(plotdat, aes(x=as.factor(change_from_previous), y=change_to_final, weight=count)) +
    geom_boxplot(outliers = FALSE) +
    theme_bw() +
    labs(x="Change in predicted wind speed",
         y="Change from prediction to final value") +
    geom_abline(slope=-1, intercept=31, linetype=4) +
    scale_x_discrete(breaks=c(-30,-25,-20,-15,-10,-5,0,5,10,15,20,25,30)) + 
    facet_wrap(~year)
)
```

## Visibility

Visibility is another prominent feature of TAFs. Looking at the autocorrelations
of predictions, again we see a striking assymmetry. Predicted improvements tend
to come true, but predicted worsened visibility tends to be pessimistic.

```{r, warning=FALSE}
plotdat <- lines %>%
  filter(variable=="visibility") %>%
  mutate(previous=pmin(previous, 6), current=pmin(current, 6), final=pmin(final, 6)) %>%
  mutate(change_from_previous=round(current-previous, digits=0), change_to_final=round(final-current, digits = 0)) %>%
  group_by(change_from_previous, change_to_final) %>%
  summarise(count=sum(count), .groups="drop")

print(
  ggplot(plotdat, aes(x=as.factor(change_from_previous), y=change_to_final, weight=count)) +
    geom_boxplot() +
    theme_bw() +
    labs(
      title="Changes in predicted visibility vs. realization",
      x="Change in predicted visibility",
         y="Change from prediction to final value")  +
    geom_abline(slope=-1, intercept=7, linetype=4) # +
    # scale_x_discrete(breaks=c(--5, 0, 5))
    )
```

## Ceiling

Looking at changes in the prediction of ceilings, we don't see a pattern as obvious
as for wind or visibility. On the median, such changes usually do not come true,
for better or for worse. However, changes in the prediction for better or for worse
are highly indicative of the forecast being uncertain.

```{r}
plotdat <- lines %>%
  filter(variable=="clouds_ceiling") %>%
  mutate(previous=round(previous/1000, 0), current=round(current/1000, 0), final=round(final/1000, 0)) %>%
  filter(current<=10) %>%
  mutate(change_from_previous=current-previous, change_to_final=final-current) %>%
  group_by(change_from_previous, change_to_final) %>%
  summarise(count=sum(count), .groups = "drop") %>%
  mutate(increase=pmax(change_from_previous,0), decrease=pmin(change_from_previous, 0)) %>%
  ungroup()

print(
  ggplot(plotdat, aes(x=as.factor(change_from_previous), y=change_to_final, weight=count)) +
    geom_boxplot(outliers = FALSE) +
    theme_bw() +
    labs(x="Change in predicted ceiling (K ft)",
         y="Change from prediction to final value") +
    # geom_abline(slope=-1, intercept=31, linetype=4) +
    scale_x_discrete(breaks=c(-15, -10, -5, 0, 5, 10)) 
)
```



